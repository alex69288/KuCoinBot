# ============================================
# Amvera Cloud Configuration - Node.js Backend + React Frontend
# ============================================
# Документация: https://docs.amvera.ru/
# Этот проект использует Node.js backend + React frontend + Python ML microservice

meta:
  environment: nodejs
  toolchain:
    name: npm
    version: 20

build:
  # Команды для сборки проекта
  args:
    - echo "=== BUILD START v0.1.63 ==="
    - pwd
    - ls -la
    - echo "=== Installing frontend dependencies ==="
    - cd frontend && npm install --ignore-scripts --no-optional --legacy-peer-deps
    - echo "=== Building frontend ==="
    - cd frontend && npm run build
    - cd ..
    - echo "=== Installing backend dependencies ==="
    - cd backend && npm install --ignore-scripts --no-optional --legacy-peer-deps
    - echo "=== Building backend ==="
    - cd backend && npm run build
    - echo "=== Build output ==="
    - ls -la backend/dist/
    - echo "=== BUILD COMPLETE ==="

run:
  # Запуск приложения — если dist отсутствует, собираем перед стартом
  # Запуск через скрипт с guard'ом — избегаем проблем с кавычками/CRLF
  command: bash backend/start.sh
  # Монтирование данных для персистентности
  persistenceMount: /data
  # Порт контейнера
  containerPort: 3000

# Health check для проверки работоспособности
healthcheck:
  path: /health
  interval: 30
  timeout: 10
  retries: 3

# Переменные окружения устанавливаются в панели Amvera:
# - KUCOIN_API_KEY
# - KUCOIN_API_SECRET
# - KUCOIN_API_PASSPHRASE
# - KUCOIN_TESTNET=false
# - NODE_ENV=production
# - TELEGRAM_BOT_TOKEN
# - TELEGRAM_CHAT_ID
