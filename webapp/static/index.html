<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KuCoin Trading Bot</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      padding: 16px;
      padding-bottom: 80px;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      border-radius: 12px;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .status-running {
      background: #4CAF50;
      color: white;
    }

    .status-stopped {
      background: #f44336;
      color: white;
    }

    .card {
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: var(--tg-theme-text-color, #000000);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--tg-theme-hint-color, #ccc);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--tg-theme-hint-color, #999);
      font-size: 14px;
    }

    .info-value {
      font-weight: 600;
      font-size: 14px;
    }

    .positive {
      color: #4CAF50;
    }

    .negative {
      color: #f44336;
    }

    .controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--tg-theme-bg-color, #ffffff);
      padding: 16px;
      border-top: 1px solid var(--tg-theme-hint-color, #ccc);
      display: flex;
      gap: 12px;
    }

    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn:active {
      opacity: 0.7;
    }

    .btn-start {
      background: #4CAF50;
      color: white;
    }

    .btn-stop {
      background: #f44336;
      color: white;
    }

    .btn-refresh {
      background: var(--tg-theme-button-color, #3390ec);
      color: var(--tg-theme-button-text-color, #ffffff);
    }

    .loader {
      text-align: center;
      padding: 40px;
      color: var(--tg-theme-hint-color, #999);
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .metric-card {
      background: var(--tg-theme-bg-color, #ffffff);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 12px;
      color: var(--tg-theme-hint-color, #999);
    }

    .last-update {
      text-align: center;
      color: var(--tg-theme-hint-color, #999);
      font-size: 12px;
      margin-top: 16px;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>ü§ñ Trading Bot</h1>
    <div id="statusBadge" class="status-badge">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <div id="errorContainer"></div>
  <div id="content" class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

  <div class="controls">
    <button id="btnStart" class="btn btn-start" onclick="startBot()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
    <button id="btnStop" class="btn btn-stop" onclick="stopBot()">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    <button id="btnRefresh" class="btn btn-refresh" onclick="loadData()">üîÑ</button>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
    document.body.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
    document.body.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
    document.body.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
    document.body.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#3390ec');
    document.body.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
    document.body.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f0f0f0');

    // API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å ‚Äî –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Ç–æ–º –∂–µ —Ö–æ—Å—Ç–µ)
    const API_URL = '/api';
    const initData = tg.initData;

    let currentData = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
      try {
        showError('');

        // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞
        const statusResponse = await fetch(`${API_URL}/status?init_data=${encodeURIComponent(initData)}`);
        if (!statusResponse.ok) {
          throw new Error(`HTTP ${statusResponse.status}: ${statusResponse.statusText}`);
        }
        const status = await statusResponse.json();

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä—ã–Ω–∫–∞
        const marketResponse = await fetch(`${API_URL}/market?init_data=${encodeURIComponent(initData)}`);
        const market = await marketResponse.ok ? await marketResponse.json() : null;

        currentData = { status, market };
        renderData();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        showError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    function renderData() {
      if (!currentData) return;

      const { status, market } = currentData;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
      const statusBadge = document.getElementById('statusBadge');
      if (status.is_running) {
        statusBadge.textContent = 'üü¢ –†–∞–±–æ—Ç–∞–µ—Ç';
        statusBadge.className = 'status-badge status-running';
      } else {
        statusBadge.textContent = 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
        statusBadge.className = 'status-badge status-stopped';
      }

      // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      let html = '';

      // –ë–∞–ª–∞–Ω—Å
      if (status.balance) {
        html += `
                    <div class="card">
                        <h2>üí∞ –ë–∞–ª–∞–Ω—Å</h2>
                        <div class="info-row">
                            <span class="info-label">USDT</span>
                            <span class="info-value">${formatNumber(status.balance.usdt || 0)} USDT</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">–û–±—â–∏–π (USDT)</span>
                            <span class="info-value">${formatNumber(status.balance.total_usdt || 0)} USDT</span>
                        </div>
                    </div>
                `;
      }

      // –ü–æ–∑–∏—Ü–∏—è
      if (status.position) {
        html += `
                    <div class="card">
                        <h2>üìä –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è</h2>
                        <div class="info-row">
                            <span class="info-label">–°—Ç–∞—Ç—É—Å</span>
                            <span class="info-value">${status.position.position || '–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–∏'}</span>
                        </div>
                        ${status.position.entry_price ? `
                        <div class="info-row">
                            <span class="info-label">–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞</span>
                            <span class="info-value">${formatNumber(status.position.entry_price)} USDT</span>
                        </div>
                        ` : ''}
                        ${status.position.amount ? `
                        <div class="info-row">
                            <span class="info-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                            <span class="info-value">${formatNumber(status.position.amount)}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
      }

      // –†—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      if (market) {
        const priceChange = market.price_change_24h || 0;
        const priceChangeClass = priceChange >= 0 ? 'positive' : 'negative';

        html += `
                    <div class="card">
                        <h2>üíπ –†—ã–Ω–æ–∫ (${market.symbol})</h2>
                        <div class="info-row">
                            <span class="info-label">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</span>
                            <span class="info-value">${formatNumber(market.current_price)} USDT</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">–ò–∑–º–µ–Ω–µ–Ω–∏–µ 24—á</span>
                            <span class="info-value ${priceChangeClass}">${priceChange > 0 ? '+' : ''}${formatNumber(priceChange)}%</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">–ú–∞–∫—Å–∏–º—É–º 24—á</span>
                            <span class="info-value">${formatNumber(market.high_24h)} USDT</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">–ú–∏–Ω–∏–º—É–º 24—á</span>
                            <span class="info-value">${formatNumber(market.low_24h)} USDT</span>
                        </div>
                    </div>
                `;
      }

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
      if (status.settings) {
        html += `
                    <div class="card">
                        <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                        <div class="info-row">
                            <span class="info-label">–¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞</span>
                            <span class="info-value">${status.settings.active_pair}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">–°—Ç—Ä–∞—Ç–µ–≥–∏—è</span>
                            <span class="info-value">${status.settings.active_strategy}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É</span>
                            <span class="info-value">${status.settings.risk_per_trade}%</span>
                        </div>
                    </div>
                `;
      }

      // –ú–µ—Ç—Ä–∏–∫–∏
      if (status.metrics) {
        const winRate = status.metrics.total_trades > 0
          ? (status.metrics.winning_trades / status.metrics.total_trades * 100).toFixed(1)
          : 0;

        html += `
                    <div class="card">
                        <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value">${status.metrics.total_trades}</div>
                                <div class="metric-label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value ${status.metrics.total_profit >= 0 ? 'positive' : 'negative'}">
                                    ${status.metrics.total_profit >= 0 ? '+' : ''}${formatNumber(status.metrics.total_profit)}
                                </div>
                                <div class="metric-label">–ü—Ä–∏–±—ã–ª—å USDT</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value positive">${status.metrics.winning_trades}</div>
                                <div class="metric-label">–ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value negative">${status.metrics.losing_trades}</div>
                                <div class="metric-label">–£–±—ã—Ç–æ—á–Ω—ã—Ö</div>
                            </div>
                        </div>
                        <div class="info-row" style="margin-top: 12px;">
                            <span class="info-label">–í–∏–Ω—Ä–µ–π—Ç</span>
                            <span class="info-value">${winRate}%</span>
                        </div>
                    </div>
                `;
      }

      // –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      html += `<div class="last-update">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleTimeString('ru-RU')}</div>`;

      document.getElementById('content').innerHTML = html;
    }

    // –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    async function startBot() {
      try {
        const response = await fetch(`${API_URL}/bot/start`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ init_data: initData })
        });

        const result = await response.json();
        tg.showAlert(result.message);
        loadData();
      } catch (error) {
        tg.showAlert(`–û—à–∏–±–∫–∞: ${error.message}`);
      }
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
    async function stopBot() {
      try {
        const response = await fetch(`${API_URL}/bot/stop`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ init_data: initData })
        });

        const result = await response.json();
        tg.showAlert(result.message);
        loadData();
      } catch (error) {
        tg.showAlert(`–û—à–∏–±–∫–∞: ${error.message}`);
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
    function showError(message) {
      const container = document.getElementById('errorContainer');
      if (message) {
        container.innerHTML = `<div class="error">${message}</div>`;
      } else {
        container.innerHTML = '';
      }
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª
    function formatNumber(num) {
      if (num === null || num === undefined) return '0';
      return parseFloat(num).toLocaleString('ru-RU', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 8
      });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadData();

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    setInterval(loadData, 5000);
  </script>
</body>

</html>