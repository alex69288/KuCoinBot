<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KuCoin Trading Bot</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #2196F3;
      --success-color: #4CAF50;
      --danger-color: #f44336;
      --warning-color: #ff9800;
      --bg-primary: var(--tg-theme-bg-color, #ffffff);
      --bg-secondary: var(--tg-theme-secondary-bg-color, #f5f5f5);
      --text-primary: var(--tg-theme-text-color, #000000);
      --text-secondary: var(--tg-theme-hint-color, #999999);
      --border-color: rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      padding: 16px;
      padding-bottom: 80px;
      overflow-x: hidden;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 12px;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .header .subtitle {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .card {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .info-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active {
      background: var(--success-color);
      color: white;
    }

    .status-inactive {
      background: var(--danger-color);
      color: white;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 12px;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .spinner {
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .price-change-positive {
      color: var(--success-color);
    }

    .price-change-negative {
      color: var(--danger-color);
    }

    .controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-primary);
      padding: 16px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-secondary);
      padding: 12px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: slideDown 0.3s ease-out;
      z-index: 1000;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>ü§ñ Trading Bot</h1>
    <p class="subtitle">KuCoin –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è</p>
  </div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
  </div>

  <div id="content" style="display: none;">
    <!-- –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞ -->
    <div class="card">
      <div class="card-title">üìä –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞</div>
      <div class="info-row">
        <span class="info-label">–¢–æ—Ä–≥–æ–≤–ª—è</span>
        <span class="status-badge" id="trading-status">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">–ë–∞–ª–∞–Ω—Å</span>
        <span class="info-value" id="balance">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">–ü–æ–∑–∏—Ü–∏—è</span>
        <span class="info-value" id="position">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">–ü—Ä–∏–±—ã–ª—å/–£–±—ã—Ç–æ–∫</span>
        <span class="info-value" id="pnl">-</span>
      </div>
    </div>

    <!-- –†—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
    <div class="card">
      <div class="card-title">üíπ –†—ã–Ω–æ–∫</div>
      <div class="info-row">
        <span class="info-label">–ü–∞—Ä–∞</span>
        <span class="info-value" id="market-symbol">BTC/USDT</span>
      </div>
      <div class="info-row">
        <span class="info-label">–¶–µ–Ω–∞</span>
        <span class="info-value" id="market-price">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">–ò–∑–º–µ–Ω–µ–Ω–∏–µ 24—á</span>
        <span class="info-value" id="market-change">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">–û–±—ä–µ–º 24—á</span>
        <span class="info-value" id="market-volume">-</span>
      </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="card">
      <div class="card-title">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
      <button class="btn btn-success" id="btn-start" onclick="startBot()">
        ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é
      </button>
      <button class="btn btn-danger" id="btn-stop" onclick="stopBot()" style="display: none;">
        ‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é
      </button>
      <button class="btn btn-warning" onclick="openSettings()">
        ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
      </button>
      <button class="btn btn-primary" onclick="refreshData()">
        üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      </button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.enableClosingConfirmation();

    let updateInterval;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function () {
      console.log('üöÄ WebApp –∑–∞–≥—Ä—É–∂–µ–Ω');
      console.log('üì± Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof tg !== 'undefined');
      console.log('üîë Init data:', tg.initData ? '–ï—Å—Ç—å' : '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
      loadData();
      startAutoUpdate();
    });

    // –ü–æ–ª—É—á–µ–Ω–∏–µ init_data –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function getInitData() {
      return tg.initData || '';
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
      try {
        console.log('üìä –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...');
        await Promise.all([loadStatus(), loadMarket()]);
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        console.error('‚ùå –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error.message, error.stack);
        showNotification(`–û—à–∏–±–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
        document.getElementById('loading').style.display = 'none';
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞
    async function loadStatus() {
      console.log('üì° –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...');
      const response = await fetch(`/api/status?init_data=${encodeURIComponent(getInitData())}`);

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      console.log('üìä –°—Ç–∞—Ç—É—Å –ø–æ–ª—É—á–µ–Ω:', data);
      console.log('üìä –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:', {
        trading_enabled: typeof data.trading_enabled,
        balance: typeof data.balance,
        position: typeof data.position,
        pnl: typeof data.pnl
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç–æ—Ä–≥–æ–≤–ª–∏
      const statusBadge = document.getElementById('trading-status');
      if (data.trading_enabled) {
        statusBadge.textContent = '–ê–∫—Ç–∏–≤–Ω–∞';
        statusBadge.className = 'status-badge status-active';
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'block';
      } else {
        statusBadge.textContent = '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞';
        statusBadge.className = 'status-badge status-inactive';
        document.getElementById('btn-start').style.display = 'block';
        document.getElementById('btn-stop').style.display = 'none';
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
      const balance = typeof data.balance === 'number' ? data.balance : (data.balance?.total_usdt || 0);
      document.getElementById('balance').textContent = `${balance.toFixed(2)} USDT`;
      document.getElementById('position').textContent = data.position || '–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–∏';

      const pnl = data.pnl || 0;
      const pnlElement = document.getElementById('pnl');
      pnlElement.textContent = `${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} USDT`;
      pnlElement.className = `info-value ${pnl >= 0 ? 'price-change-positive' : 'price-change-negative'}`;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    async function loadMarket() {
      try {
        console.log('üìà –ó–∞–≥—Ä—É–∑–∫–∞ —Ä—ã–Ω–∫–∞...');
        const response = await fetch(`/api/market?init_data=${encodeURIComponent(getInitData())}`);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('üìä –†—ã–Ω–æ–∫ –ø–æ–ª—É—á–µ–Ω:', data);
        console.log('üìä –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö —Ä—ã–Ω–∫–∞:', {
          symbol: typeof data.symbol,
          current_price: typeof data.current_price,
          change_24h: typeof data.change_24h
        });

        document.getElementById('market-symbol').textContent = data.symbol || 'BTC/USDT';
        document.getElementById('market-price').textContent = `$${data.current_price?.toFixed(2) || '0.00'}`;

        const change = data.change_24h || 0;
        const changeElement = document.getElementById('market-change');
        changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
        changeElement.className = `info-value ${change >= 0 ? 'price-change-positive' : 'price-change-negative'}`;

        document.getElementById('market-volume').textContent = `$${formatNumber(data.volume_24h || 0)}`;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä—ã–Ω–∫–∞:', error);
      }
    }

    // –ó–∞–ø—É—Å–∫ —Ç–æ—Ä–≥–æ–≤–ª–∏
    async function startBot() {
      try {
        const response = await fetch('/api/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ init_data: getInitData() })
        });

        const result = await response.json();
        if (result.success) {
          showNotification('‚úÖ –¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–ø—É—â–µ–Ω–∞');
          await loadStatus();
        } else {
          showNotification('‚ùå ' + (result.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞'));
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞');
      }
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
    async function stopBot() {
      try {
        const response = await fetch('/api/stop', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ init_data: getInitData() })
        });

        const result = await response.json();
        if (result.success) {
          showNotification('‚è∏Ô∏è –¢–æ—Ä–≥–æ–≤–ª—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
          await loadStatus();
        } else {
          showNotification('‚ùå ' + (result.message || '–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏'));
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏');
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    async function refreshData() {
      showNotification('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
      await loadData();
    }

    // –û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    function openSettings() {
      tg.showPopup({
        title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
        message: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /settings',
        buttons: [{ type: 'ok' }]
      });
    }

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    function startAutoUpdate() {
      updateInterval = setInterval(() => {
        loadStatus();
        loadMarket();
      }, 5000); // –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª
    function formatNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(2) + 'M';
      } else if (num >= 1000) {
        return (num / 1000).toFixed(2) + 'K';
      }
      return num.toFixed(2);
    }

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    window.addEventListener('beforeunload', () => {
      if (updateInterval) {
        clearInterval(updateInterval);
      }
    });
  </script>
</body>

</html>