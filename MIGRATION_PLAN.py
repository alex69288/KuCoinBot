"""
ПЛАН МИГРАЦИИ К СИСТЕМЕ С НЕСКОЛЬКИМИ ПОЗИЦИЯМИ

ТЕКУЩАЯ СИТУАЦИЯ:
- Баланс BTC: 0.00002 (2 покупки)
- Position_state: 1 позиция с общим размером 1.032 USDT
- API возвращает только 1 ордер (05.11)

ПРОБЛЕМА:
- Невозможно восстановить детали старых покупок из API
- Но нужно начать отслеживать каждую покупку отдельно

РЕШЕНИЕ:
1. Создать ПЕРЕХОДНУЮ структуру:
   - Для существующих позиций: создать "агрегированную" запись
   - Для новых покупок: создавать отдельные записи

2. Новая структура position_state.json:
{
  "BTC/USDT": {
    "positions": [
      {
        "id": "legacy_1",  # Старые позиции помечаем как legacy
        "entry_price": 103203.3,  # Средняя цена
        "position_size_usdt": 1.032,
        "amount_crypto": 0.00001,
        "opened_at": 1762700644756,
        "is_legacy": true,  # Флаг для обработки
        "note": "Агрегированная позиция из старой системы"
      }
    ],
    "total_position_size_usdt": 1.032,
    "average_entry_price": 103203.3,
    "total_amount_crypto": 0.00001
  }
}

3. При НОВОЙ покупке:
   - Добавляем позицию с реальными данными ордера
   - Пересчитываем total/average

4. При ПРОДАЖЕ:
   - FIFO: закрываем самую старую позицию
   - Или частично закрываем (если продали меньше)

ПРЕИМУЩЕСТВА:
✅ Не теряем текущее состояние
✅ С этого момента точно отслеживаем каждую покупку
✅ Можем показывать правильное количество позиций
✅ Легко мигрировать без потери данных
"""

print(__doc__)
