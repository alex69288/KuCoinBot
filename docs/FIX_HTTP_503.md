# Решение проблемы HTTP 503 на Amvera

## Проблема
После исправления HTTP 500, возникла ошибка HTTP 503 (Service Unavailable).

## Причины HTTP 503
1. Сервер запускается, но падает до того, как начинает обрабатывать запросы
2. Сервер не отвечает на health check запросы
3. Порт не открывается вовремя
4. Ошибка при инициализации приложения

## Решения

### 1. Улучшена обработка ошибок в webapp_only.py
- Добавлены детальные логи импорта модулей
- Разделены типы ошибок (ImportError, KeyboardInterrupt, Exception)
- Добавлен вывод типа ошибки и полного traceback
- Увеличен timeout_keep_alive до 30 секунд

### 2. Добавлен healthcheck в amvera.yml
```yaml
healthcheck:
  path: /ping
  interval: 30
  timeout: 10
  retries: 3
```

Это позволяет Amvera проверять, что сервер отвечает на запросы.

### 3. Созданы дополнительные файлы для диагностики

#### minimal_server.py
Минимальный тестовый сервер для проверки базовой функциональности:
```python
# Если даже он не работает - проблема в инфраструктуре
python minimal_server.py
```

#### tests/test_server_diagnostics.py
Полная диагностика всех серверов перед деплоем:
```bash
python tests/test_server_diagnostics.py
```

## Шаги для развертывания

### 1. Локальная проверка
```bash
# Запустите диагностику
python tests/test_server_diagnostics.py

# Убедитесь, что все тесты проходят
# ✅ Минимальный сервер: PASSED
# ✅ Основной webapp: PASSED
# ✅ webapp_only.py: PASSED
```

### 2. Коммит изменений
```bash
git add .
git commit -m "[v1.0.2] Исправление HTTP 503: улучшена обработка ошибок и добавлен healthcheck"
git push
```

### 3. Перезапуск на Amvera
1. Зайдите в панель Amvera
2. Перезапустите проект
3. Проверьте логи на наличие ошибок

### 4. Проверка работоспособности
После развертывания проверьте endpoints:
- `https://your-app.amvera.io/ping` - должен вернуть `{"ping": "pong"}`
- `https://your-app.amvera.io/api/health` - должен вернуть статус
- `https://your-app.amvera.io/` - главная страница

## Альтернативные варианты

### Вариант A: Тест с минимальным сервером
Если проблема сохраняется, измените `amvera.yml`:
```yaml
run:
  scriptName: minimal_server.py
```

Это поможет понять, проблема в коде или в конфигурации.

### Вариант B: Проверка логов Amvera
1. Откройте раздел "Логи" в панели Amvera
2. Найдите сообщения об ошибках
3. Если есть ошибки импорта - проверьте requirements.txt
4. Если ошибки при старте - проверьте переменные окружения

## Чеклист проверки
- [ ] Все тесты проходят локально
- [ ] Код закоммичен и отправлен на GitHub
- [ ] Проект перезапущен на Amvera
- [ ] `/ping` endpoint отвечает
- [ ] `/api/health` endpoint отвечает
- [ ] Главная страница загружается
- [ ] Логи не содержат ошибок

## Дата исправления
11 ноября 2025 г.
