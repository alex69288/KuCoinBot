# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ 401 –∏ —Å–±—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏—è—Ö (v0.1.19)

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (`main_dev.py`) –Ω–∞–±–ª—é–¥–∞–ª–∏—Å—å —Å–ª–µ–¥—É—é—â–∏–µ –æ—à–∏–±–∫–∏:

```
INFO:     127.0.0.1:64572 - "GET /api/status?init_data=debug_mode HTTP/1.1" 401 Unauthorized
INFO:     127.0.0.1:49720 - "GET /api/market?init_data=&compact=1 HTTP/1.1" 401 Unauthorized
INFO:     127.0.0.1:49721 - "GET /api/market?init_data=&compact=1 HTTP/1.1" 401 Unauthorized
```

–ü–æ—Å–ª–µ –ø–æ—è–≤–ª–µ–Ω–∏—è —ç—Ç–∏—Ö –æ—à–∏–±–æ–∫ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–∑–∏—Ü–∏—è—Ö (—Ä–∞–∑–º–µ—Ä —Å—Ç–∞–≤–∫–∏, —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞, —Ç–µ–∫—É—â–∞—è –ø—Ä–∏–±—ã–ª—å –¥–æ take profit) —Å–±—Ä–∞—Å—ã–≤–∞–ª–∏—Å—å –≤ 0.

## –ü—Ä–∏—á–∏–Ω–∞

### 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
–ö–æ–≥–¥–∞ WebApp –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ (–Ω–µ –≤ Telegram), `window.Telegram?.WebApp?.initData` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –∏–ª–∏ `undefined`. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:

- JavaScript –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–µ—Ä–µ–¥–∞–µ—Ç `init_data=debug_mode` –∏–ª–∏ `init_data=` 
- –§—É–Ω–∫—Ü–∏—è `verify_telegram_webapp_data()` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`
- API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 Unauthorized
- –î–∞–Ω–Ω—ã–µ –æ –ø–æ–∑–∏—Ü–∏—è—Ö –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, UI –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ–∂–∏–º–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
–í –∫–æ–¥–µ –Ω–µ –±—ã–ª–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, —á—Ç–æ –¥–µ–ª–∞–ª–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebApp –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ Telegram.

## –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `webapp/server.py`

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `DEV_MODE` –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

```python
def verify_telegram_webapp_data(init_data: str, bot_token: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram Web App
    
    –í —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (DEV_MODE=1) –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    """
    # üîß –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
    dev_mode = os.getenv('DEV_MODE', '0') == '1'
    if dev_mode:
        log_info("[DEV] –ü—Ä–æ–ø—É—Å–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏")
        return True
    
    # –ü—É—Å—Ç–æ–π init_data - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤ DEV —Ä–µ–∂–∏–º–µ
    if not init_data or init_data == 'debug_mode':
        if dev_mode:
            return True
        log_error("[AUTH] –ü—É—Å—Ç–æ–π init_data –≤ production —Ä–µ–∂–∏–º–µ")
        return False
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ö—ç—à–∞
```

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `main_dev.py`

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ `DEV_MODE=1` –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏:

```python
# ========================================
# –í–ê–ñ–ù–û: –ó–∞–≥—Ä—É–∑–∫–∞ .env –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
# ========================================
print("üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞...", flush=True)
load_dotenv()
print("‚úÖ –§–∞–π–ª .env –∑–∞–≥—Ä—É–∂–µ–Ω", flush=True)

# üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ WebApp
os.environ['DEV_MODE'] = '1'
print("üîß DEV_MODE –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (–ø—Ä–æ–ø—É—Å–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ WebApp)", flush=True)
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç `tests/test_webapp_auth.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

```python
def test_dev_mode_auth():
    """–¢–µ—Å—Ç –ø—Ä–æ–ø—É—Å–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ DEV_MODE"""
    os.environ['DEV_MODE'] = '1'
    
    # –¢–µ—Å—Ç 1: –ü—É—Å—Ç–æ–π init_data
    result1 = verify_telegram_webapp_data('', 'test_token')
    assert result1 == True
    
    # –¢–µ—Å—Ç 2: debug_mode
    result2 = verify_telegram_webapp_data('debug_mode', 'test_token')
    assert result2 == True
    
    # –¢–µ—Å—Ç 3: Production —Ä–µ–∂–∏–º
    os.environ['DEV_MODE'] = '0'
    result3 = verify_telegram_webapp_data('', 'test_token')
    assert result3 == False
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–æ–≤:**
```
‚úÖ –¢–µ—Å—Ç 1: –ü—É—Å—Ç–æ–π init_data –ø—Ä–æ—Ö–æ–¥–∏—Ç
‚úÖ –¢–µ—Å—Ç 2: debug_mode –ø—Ä–æ—Ö–æ–¥–∏—Ç
‚úÖ –¢–µ—Å—Ç 3: –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π init_data –ø—Ä–æ—Ö–æ–¥–∏—Ç
‚úÖ –¢–µ—Å—Ç 4: –ü—É—Å—Ç–æ–π init_data –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –≤ production
‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Production —Ä–µ–∂–∏–º
–í production —Ä–µ–∂–∏–º–µ (Amvera, Railway) –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `DEV_MODE` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–ª–∏ —Ä–∞–≤–Ω–∞ `0`, –ø–æ—ç—Ç–æ–º—É:
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –ü—É—Å—Ç–æ–π `init_data` –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å –≤–∞–ª–∏–¥–Ω—ã–º Telegram hash

### Development —Ä–µ–∂–∏–º
–í –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ (`main_dev.py`):
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- WebApp —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ
- –ú–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ Telegram

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ 401 –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
- ‚úÖ –î–∞–Ω–Ω—ã–µ –æ –ø–æ–∑–∏—Ü–∏—è—Ö –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ UI –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- ‚úÖ Production —Ä–µ–∂–∏–º –∑–∞—â–∏—â–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ Telegram

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. `webapp/server.py` - –¥–æ–±–∞–≤–ª–µ–Ω DEV_MODE –≤ `verify_telegram_webapp_data()`
2. `main_dev.py` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ `DEV_MODE=1`
3. `tests/test_webapp_auth.py` - –Ω–æ–≤—ã–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## –í–µ—Ä—Å–∏—è

**v0.1.19** - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ 401 Unauthorized –∏ —Å–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏—è—Ö –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
